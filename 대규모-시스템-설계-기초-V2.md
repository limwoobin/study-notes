# 대규모 시스템 설계 기초 2권

# 1장 근접성 서비스

음식점, 호텔, 극장, 박물관 등 현재 위치에서 가까운 시설을 찾는데 이용되는 서비스

Q. 사용자가 검색 반경(radius)을 지정할 수 있나요? 사업장이 충분치 않은 경우엔 시스템이 알아서
범위를 넓혀도 괜찮나요?
A. 일단은 주어진 범위내의 사업장만 대상으로 합니다

Q. 최대 허용 반경은 얼마인가요? 20km 로 해도 괜찮나요?
A. 네 괜찮습니다.

Q. 사용자가 UI 에서 검색반경을 변경할 수 있어야 하나요?
A. 네 다음 선택지가 주어져야합니다 (0.5km, 1km, 2km ...)

Q. 사업장 정보는 어떻게 추가되고 갱신되나요? 사업장 정보가 실시간으로 보여져야 하나요?
A. 사업장 소유주가 사업장 정보를 시스템에 추가/삭제/갱신할 수 있어야 합니다. 
갱신은 다음날까지 반영되야 합니다.

Q. 사용자의 이동에 따라 화면을 갱신해야 할까요?
A. 이동속도가 빠르지 않으니 상시적으로 갱신할 필요는 없다고 가정합니다.


기능 요구사항
- 사용자의 위치와 검색반경 정보에 따라 매치되는 사업장 정보 반환
- 사업장 소유주가 사업장 정보를 추가/삭제/갱신할 수 있도록 하되, 실시간으로 반영될 필요는 없음
- 고객은 사업장의 상세정보를 살필 수 있어야 함

비기능 요구사항
- 낮은 응답 지연(latency): 주변 사업장을 신속히 검색할 수 있어야 함
- 데이터 보호: 사용자 위치는 민감한 정보임
- 고가용성 및 규모 확장성: 인구 밀집지역에서 이용자가 집중되어도 트래픽을 감당할 수 있어야함

계략적 규모 추정
- DAU 는 1억명, 등록된 사업장 수는 2억이라고 가정

* QPS 계산
- 1일 = 24시간 * 60분 * 60초 = 86,400 초
- 한 사용자는 하루에 5회 검색을 시도한다고 가정
- 따라서 QPS = (1억 * 5) / 86,400

데이터 모델
ㄴ 읽기/쓰기 비율 및 스키마 설계에 대해 알아보자

읽기/쓰기 비율
- 다음 시스템은 사업장 검색 및 정보확인이 주 기능이므로 쓰기보다 읽기 연산이 훨씬 많다
- 이러한 읽기 연산이 압도적인 시스템에서는 MySQL 같은 RDB 가 바람직 할 수 있다

데이터 스키마
- 핵심 테이블은 business 테이블과 지리적 위치 색인 테이블이다.

주변 사업장 검색 알고리즘
- 많은 회사가 레디스 GioHash 혹은 PostGIS 를 설치한 PostGres DB 를 활용한다

방안1. 2차원 검색
- 주어진 반경으로 그린 원 안에 놓인 사업장을 검색하는 방법

지리적 정보에 색인을 만드는 방법
1. 해시 기반 방안 - 균등 격자(even grid), 지오해시(geohash), 카르테시안 계층(cartesian tiers)
2. 트리 기반 방안 - 쿼드트리(quadtree), 구글 S2, R 트리

구현방법은 서로 다르지만 개략적인 아이디어는 같다.
즉, 지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인을 만드는 것이다
이중, 지오해시, 쿼드트리, 구글S2 는 실제로 가장 널리 사용되는 방안이다

방안2. 균등 격자
- 지도를 작은 격자 또는 구획으로 나누는 단순한 접근법
- 이렇게 하면 하나의 격자는 여러 사업장을 담을 수 있고, 하나의 사업장은 오직 한 격자 안에만 속하게 됨
- 이 방법은 중요한 문제가 있음 > 바로 사업장 분포가 균등하지 않음 e.g) 사막이나 바다 같은곳도 존재

방안3. 지오해시(geohash)
- 지오해시는 균등 격자보다 나은 방안이다.
- 2차원의 위도 경도 데이터를 1차원의 문자열로 변환
- 지오해시 알고리즘은 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할해간다
- 이 절차를 원하는 정밀도를 얻을때까지 반복한다
- 지오해시는 12단계의 정밀도를 갖는다, 이 정밀도가 격자 크기를 결정한다 
(1에 가까울수록 범위가 크고 12에 가까울수록 범위가 작다)

- 이 접근법은 잘 동작하지만 격자 가장자리의 처리방식에 관한 이슈가 있다
- 격자들의 가장자리에 값이 서로 다를수 있는데 이때 가장 흔한 해결책은 
현재 격자를 비롯한 인접한 모든 격자의 모든 사업자 정보를 가져오는 것이다

방안4. 쿼드트리
- 격자의 내용이 특정 기준을 만족할때까지 2차원 공간을 재귀적으로 사분면 분할하는데 사용되는 자료구조
- 예를들면, 격자에 담긴 사업장 수가 100 이하가 될때까지 분할하는 것.
- 쿼드트리 인덱스는 메모리를 많이 잡아먹지 않으므로 서버 한대에 충분히 올릴 수 있다
- 인구 밀집지역에는 작은 격자를, 그렇지 않은 지역에는 큰 격자를 사용할 수 있다

방안5. 구글S2
- 지구를 힐베르트 곡선이라는 공간 채움 곡선을 사용해 1차원 색인화 하는 방안

## 지오해시 vs 쿼드트리

지오해시
- 빙 지도, 레디스, MongoDB 에서 사용
- 구현과 사용이 쉬움, 트리를 구축할 필요 없음
- 지정 반경 이내의 사업장 검색을 지원
- 정밀도를 고정하면 격자 크기도 고정됨, 다만 인구밀도에 따라 동적으로 격자크기를 고정할 수는 없음
- 색인 갱신이 쉽다

쿼드트리
- 엑스트(Yext) 에서 사용
- 구현하기 까다로움, 트리를 구축해야 해서
- n 번째로 가까운 사업장까지의 목록을 구할 수 있음
- 인구밀도에 따라 격자 크기를 동적으로 조정할 수 있음
- 색인 갱신이 까다로움

## 상세설계

데이터베이스의 규모 확장성
- 사업장 테이블
ㄴ 사업장 테이블은 한 서버에 담을 수 없을 수 있다
ㄴ 샤딩을 적용하기 알맞은 후보이다
ㄴ 샤딩은 사업장 ID 를 기준으로 처리한다

- 지리 정보 색인 테이블
ㄴ 방안1. 지오해시에 연결되는 모든 사업장ID 를 JSON 배열로 만들어 같은 열에 저장하는 방안
ㄴ 방안2. 같은 지오해시에 속한 사업장ID 를 각각 별도 열로 저장하는 방안
따라서 사업장마다 한 개의 레코드가 필요

추천하는것은 방안2번 이다.
- 사업장 정보 갱신이 1번방안은 배열을 읽고 ID 를 찾고 과정이 번거롭다. 등록의 경우에도 모든 배열을 읽어야 한다.
- 병렬로 실행하는 경우 갱신으로 인한 유실을 막기 위해 락을 사용해야 한다
- 방안2의 경우 지오해시와 사업장ID 컬럼을 복합키로 사용하면 추가/삭제하기도 쉽고 락을 사용할 필요도 없다.

캐시 키
- 사용자의 위도,경도 정보는 캐시키로 사용하기 알맞지 않다
ㄴ 위치 정보는 추정치일뿐 아주 정확하지 않다
ㄴ 정보는 사용자가 이동할때마다 조금씩 달라진다

캐시 데이터 유형
- 다음 데이터는 캐시하면 시스템 성능을 향상시킬 수 있따
ㄴ 지오해시 - 해당 격자 내의 사업장 ID 목록
ㄴ 사업장 ID - 사업장 정보 객체

지역 및 가용성 구역
- 지금까지 살펴본 위치 기반 서비스는 여러 지역과 가용성 구역에 설치한다 기대효과는 다음과 같다
ㄴ 사용자와 시스템 사이의 물리적 거리를 최소한으로 줄일 수 있음
ㄴ 트래픽을 인구에 따라 고르게 분산하는 유연성을 확보할 수 있음