# 대규모 시스템 설계 기초 2권

# 1장 근접성 서비스

음식점, 호텔, 극장, 박물관 등 현재 위치에서 가까운 시설을 찾는데 이용되는 서비스

Q. 사용자가 검색 반경(radius)을 지정할 수 있나요? 사업장이 충분치 않은 경우엔 시스템이 알아서
범위를 넓혀도 괜찮나요?
A. 일단은 주어진 범위내의 사업장만 대상으로 합니다

Q. 최대 허용 반경은 얼마인가요? 20km 로 해도 괜찮나요?
A. 네 괜찮습니다.

Q. 사용자가 UI 에서 검색반경을 변경할 수 있어야 하나요?
A. 네 다음 선택지가 주어져야합니다 (0.5km, 1km, 2km ...)

Q. 사업장 정보는 어떻게 추가되고 갱신되나요? 사업장 정보가 실시간으로 보여져야 하나요?
A. 사업장 소유주가 사업장 정보를 시스템에 추가/삭제/갱신할 수 있어야 합니다. 
갱신은 다음날까지 반영되야 합니다.

Q. 사용자의 이동에 따라 화면을 갱신해야 할까요?
A. 이동속도가 빠르지 않으니 상시적으로 갱신할 필요는 없다고 가정합니다.


기능 요구사항
- 사용자의 위치와 검색반경 정보에 따라 매치되는 사업장 정보 반환
- 사업장 소유주가 사업장 정보를 추가/삭제/갱신할 수 있도록 하되, 실시간으로 반영될 필요는 없음
- 고객은 사업장의 상세정보를 살필 수 있어야 함

비기능 요구사항
- 낮은 응답 지연(latency): 주변 사업장을 신속히 검색할 수 있어야 함
- 데이터 보호: 사용자 위치는 민감한 정보임
- 고가용성 및 규모 확장성: 인구 밀집지역에서 이용자가 집중되어도 트래픽을 감당할 수 있어야함

계략적 규모 추정
- DAU 는 1억명, 등록된 사업장 수는 2억이라고 가정

* QPS 계산
- 1일 = 24시간 * 60분 * 60초 = 86,400 초
- 한 사용자는 하루에 5회 검색을 시도한다고 가정
- 따라서 QPS = (1억 * 5) / 86,400

데이터 모델
ㄴ 읽기/쓰기 비율 및 스키마 설계에 대해 알아보자

읽기/쓰기 비율
- 다음 시스템은 사업장 검색 및 정보확인이 주 기능이므로 쓰기보다 읽기 연산이 훨씬 많다
- 이러한 읽기 연산이 압도적인 시스템에서는 MySQL 같은 RDB 가 바람직 할 수 있다

데이터 스키마
- 핵심 테이블은 business 테이블과 지리적 위치 색인 테이블이다.

주변 사업장 검색 알고리즘
- 많은 회사가 레디스 GioHash 혹은 PostGIS 를 설치한 PostGres DB 를 활용한다

방안1. 2차원 검색
- 주어진 반경으로 그린 원 안에 놓인 사업장을 검색하는 방법

지리적 정보에 색인을 만드는 방법
1. 해시 기반 방안 - 균등 격자(even grid), 지오해시(geohash), 카르테시안 계층(cartesian tiers)
2. 트리 기반 방안 - 쿼드트리(quadtree), 구글 S2, R 트리

구현방법은 서로 다르지만 개략적인 아이디어는 같다.
즉, 지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인을 만드는 것이다
이중, 지오해시, 쿼드트리, 구글S2 는 실제로 가장 널리 사용되는 방안이다

방안2. 균등 격자
- 지도를 작은 격자 또는 구획으로 나누는 단순한 접근법
- 이렇게 하면 하나의 격자는 여러 사업장을 담을 수 있고, 하나의 사업장은 오직 한 격자 안에만 속하게 됨
- 이 방법은 중요한 문제가 있음 > 바로 사업장 분포가 균등하지 않음 e.g) 사막이나 바다 같은곳도 존재

방안3. 지오해시(geohash)
- 지오해시는 균등 격자보다 나은 방안이다.
- 2차원의 위도 경도 데이터를 1차원의 문자열로 변환
- 지오해시 알고리즘은 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할해간다
- 이 절차를 원하는 정밀도를 얻을때까지 반복한다
- 지오해시는 12단계의 정밀도를 갖는다, 이 정밀도가 격자 크기를 결정한다 
(1에 가까울수록 범위가 크고 12에 가까울수록 범위가 작다)

- 이 접근법은 잘 동작하지만 격자 가장자리의 처리방식에 관한 이슈가 있다
- 격자들의 가장자리에 값이 서로 다를수 있는데 이때 가장 흔한 해결책은 
현재 격자를 비롯한 인접한 모든 격자의 모든 사업자 정보를 가져오는 것이다

방안4. 쿼드트리
- 격자의 내용이 특정 기준을 만족할때까지 2차원 공간을 재귀적으로 사분면 분할하는데 사용되는 자료구조
- 예를들면, 격자에 담긴 사업장 수가 100 이하가 될때까지 분할하는 것.
- 쿼드트리 인덱스는 메모리를 많이 잡아먹지 않으므로 서버 한대에 충분히 올릴 수 있다
- 인구 밀집지역에는 작은 격자를, 그렇지 않은 지역에는 큰 격자를 사용할 수 있다

방안5. 구글S2
- 지구를 힐베르트 곡선이라는 공간 채움 곡선을 사용해 1차원 색인화 하는 방안

## 지오해시 vs 쿼드트리

지오해시
- 빙 지도, 레디스, MongoDB 에서 사용
- 구현과 사용이 쉬움, 트리를 구축할 필요 없음
- 지정 반경 이내의 사업장 검색을 지원
- 정밀도를 고정하면 격자 크기도 고정됨, 다만 인구밀도에 따라 동적으로 격자크기를 고정할 수는 없음
- 색인 갱신이 쉽다

쿼드트리
- 엑스트(Yext) 에서 사용
- 구현하기 까다로움, 트리를 구축해야 해서
- n 번째로 가까운 사업장까지의 목록을 구할 수 있음
- 인구밀도에 따라 격자 크기를 동적으로 조정할 수 있음
- 색인 갱신이 까다로움

## 상세설계

데이터베이스의 규모 확장성
- 사업장 테이블
ㄴ 사업장 테이블은 한 서버에 담을 수 없을 수 있다
ㄴ 샤딩을 적용하기 알맞은 후보이다
ㄴ 샤딩은 사업장 ID 를 기준으로 처리한다

- 지리 정보 색인 테이블
ㄴ 방안1. 지오해시에 연결되는 모든 사업장ID 를 JSON 배열로 만들어 같은 열에 저장하는 방안
ㄴ 방안2. 같은 지오해시에 속한 사업장ID 를 각각 별도 열로 저장하는 방안
따라서 사업장마다 한 개의 레코드가 필요

추천하는것은 방안2번 이다.
- 사업장 정보 갱신이 1번방안은 배열을 읽고 ID 를 찾고 과정이 번거롭다. 등록의 경우에도 모든 배열을 읽어야 한다.
- 병렬로 실행하는 경우 갱신으로 인한 유실을 막기 위해 락을 사용해야 한다
- 방안2의 경우 지오해시와 사업장ID 컬럼을 복합키로 사용하면 추가/삭제하기도 쉽고 락을 사용할 필요도 없다.

캐시 키
- 사용자의 위도,경도 정보는 캐시키로 사용하기 알맞지 않다
ㄴ 위치 정보는 추정치일뿐 아주 정확하지 않다
ㄴ 정보는 사용자가 이동할때마다 조금씩 달라진다

캐시 데이터 유형
- 다음 데이터는 캐시하면 시스템 성능을 향상시킬 수 있따
ㄴ 지오해시 - 해당 격자 내의 사업장 ID 목록
ㄴ 사업장 ID - 사업장 정보 객체

지역 및 가용성 구역
- 지금까지 살펴본 위치 기반 서비스는 여러 지역과 가용성 구역에 설치한다 기대효과는 다음과 같다
ㄴ 사용자와 시스템 사이의 물리적 거리를 최소한으로 줄일 수 있음
ㄴ 트래픽을 인구에 따라 고르게 분산하는 유연성을 확보할 수 있음

<br />

# 2장 주변 친구
- 앱 사용자 중 본인 위치 정보 접근 권한을 허락한 사용자에 한해 인근의 친구 목록을 보여주는 시스템

Q. 지리적으로 얼마나 가까워야 주변에 있다고 할 수 있나요?
A. 5mile 입니다. 이 수치는 설정가능해야 합니다.

Q. 그 거리는 두 사용자 사이의 직선거리로 가정해도 될까요?
A. 네 좋습니다.

Q. 얼마나 많은 사용자가 이 기능을 사용하나요? 10억명을 가정하고 그 중 10% 정도가 이 기능을 사용한다 봐도 되나요?
A. 네 좋습니다.

Q. 친구 관계에 있는 사용자가 10분 이상 비활성화 상태면 주변 친구목록에서 사라지도록 해야 할까요?
A. 사라지게 합니다.

Q. GDPR, CCPA 같은 사생활 및 데이터 보호법도 고려해야 할까요?
A. 너무 복잡해질수 있으니 고려하지 않기로 합니다.

## 기능 요구사항
- 사용자는 모바일 앱에 주변 친구를 확인할 수 있어야 함
- 주변 친구 목록에 보이는 항목에는 친구까지와의 거리, 해당 정보가 마지막으로 갱신된 시각이 함께 표시되어야 한다.
- 친구 목록은 몇초마다 한번씩 갱신되어야 한다

## 비기능 요구사항
- 낮은 지연시간: 주변 친구의 위치변화가 반영되는데 너무 오래걸리지 않게 한다
- 안정성: 전반적으로 안정적이어야 하지만, 몇 개 데이터 유실되는것 정보는 허용한다
- 결과적 일관성: 위치 데이터를 저장하기 위해 강한 일관성까지는 필요없다.
복제본의 데이터가 원본과 동일하게 변경되기까지 몇 초 정도는 허용한다

## 계략적 규모 추정
- 주변 친구는 5mile (8km) 반영 이내 친구로 정의한다
- 친구 위치 정보는 30초 주기로 갱신한다, 
사람이 30초 정도 이동한다해도 주변 친구검색결과가 크게 달라지지 않는다
- 평균적으로 매일 주변친구 검색 기능을 활용하는 사용자는 1억명으로 가정한다
- 동시접속자 수는 DAU 의 10%로 가정한다, 따라서 천만명이 동시에 시스템을 이용한다고 가정한다
- 평균적으로 한 사용자당 400명의 친구를 갖는다고 가정한다. 그리고 그 모든 친구가 주변 친구 검색기능을 활용한다고 가정한다.
- 이 앱은 페이지당 20명의 주변친구를 표시하고, 사용자의 요청이 있으면 더 많은 주변 친구를 보여준다.

+ 대략적인 QPS 계산
- 1억 DAU
- 동시 접속 사용자: 10% * 1억 = 1,000만
- 사용자는 30초마다 자기 위치를 시스템에 전송
- 위치 정보 갱신 QPS = 천만/30 = 약 334,000

## 개략적 설계안
- 이번 문제는 메시지의 효과적 전송을 가능케 할 설계안을 요구한다.
- 근방의 모든 활성 친구의 위치정보를 수신해야 할 니즈가 있다.

웹소켓 서버
- 친구 위치 정보 변경을 실시간에 가깝게 처리하는 유상태 서버 클러스터
- 각 클라이언트는 웹소켓 연결을 지속적으로 유지한다

레디스 위치 정보 캐시
- 활성 상태 사용자의 가장 최근 위치 정보를 캐시한다
- TTL 을 통해 해당 기간이 지나면 비활성화 처리한다

위치 이동 이력 데이터베이스
- 사용자의 위치 변동 이력을 보관한다

레디스 Pub/Sub 서버
- 기가바이트급 메모리를 갖춘 레디스 서버에는 수백만개의 채널을 생성할 수 있다
- 웹소켓 서버를 통해 수신한 사용자의 위치 변경 이벤트를 해당 사용자에게 배정된 Pub/Sub 채널에 발행한다
- 위치가 바뀌면 해당 사용자의 모든 친구의 웹소켓 연결 핸들러가 호출된다

주기적 위치 갱신
1. 모바일 클라이언트가 위치가 변경된 사실을 로드밸런서에게 전송
2. 로드밸런서는 그 위치 변경내역을 해당 클라이언트와 웹소켓 서버 사이에 설정된 연결을 통해
웹소켓 서버로 보낸다
3. 웹소켓 서버는 해당 이벤트를 위치 이동 이력 DB 에 저장한다.
4. 웹소켓 서버는 새 위치 정보를 캐시에 저장한다. 이후 웹소켓 연결 핸들러 안의 변수에
해당 위치를 반영한다.
5. 웹소켓 서버는 레디스 Pub/Sub 서버의 해당 사용자 채널에 새 위치를 발행한다.
6. 레디스 Pub/Sub 채널에 발행된 새로운 위치 변경 이벤트는 모든 구독자에게 브로드캐스트된다.
이때, 구독자는 위치 변경 이벤트를 보낸 사용자의 온라인 상태 친구들이다.
7. 메시지를 받은 웹소켓 서버는 새 위치를 보낸 사용자와 메시지를 보낸 사용자 사이의 거리를 새로 계산한다.


## API 설계

1. [Server] 주기적인 위치 정보 갱신
- 요청: 클라이언트의 위도, 경도, 시각정보
- 응답: 없음

2. [Client] 클라이언트가 갱신된 친구 위치를 수신하는데 사용할 API
- 친구 위치 데이터와 변경된 시각을 나타내는 타임스탬프

3. [Server] 웹소켓 초기화 API
- 요청: 클라이언트는 위도, 경도, 시각정보 전송
- 응답: 클라이언트는 자기 친구들의 위치 데이터를 수신

4. [Client] 새 친구 구독 API
- 요청: 웹소켓 서버는 친구 ID 전송
- 응답: 가장 최근의 위도, 경도, 시각 정보 전송

5. [Client] 구독 해지 API
- 요청: 웹소켓 서버는 친구 ID 전송
- 응답: 없음

# 3장 구글 맵

Q. 일간 사용자는 얼마나 되나요?
A. DAU 10억입니다

Q. 어느 기능을 중점으로 해야하나요?
A. 위치 갱신, 경로 안내, ETA, 지도 표시 등에 초점을 맞춥니다.

Q. 도로 데이터는 어느 규모인가요? 확보했다고 가정해도 되나요?
A. 도로 데이터는 확보했다고 가정합니다. 수 TB 수준의 가공되지 않은 데이터입니다.

Q. 교통상황도 고려해야 하나요?
A. 네 교통상황은 아주 중요한 정보입니다.

Q. 이동 방법도 지원해야하나요?
A. 네 지원해야 합니다.

Q. 경유지도 설정할수 있어야 하나요?
A. 경유지는 우선 제외합니다.

Q. 사업장 정보도 표시해야 하나요? 
A. 이번에는 고려하지 않습니다.

### 기능 요구사항
- 주 단말은 모바일(스마트폰)이다.
- 사용자 위치 갱신
- 경로 안내 서비스 (ETA 서비스 포함)
- 지도 표시

### 비기능 요구사항 및 제약사항
- 정확도: 사용자에게 잘못된 경로를 안내하면 안된다
- 부드러운 경로 표시: 클라이언트를 통해 제공되는 경로 안내 용도의 지도는 부드럽게 표시되어야 한다
- 클라이언트는 가능한 최소한의 데이터와 배터리를 사용해야 한다
- 일반적으로 통용되는 가용성 및 확장성을 만족해야 한다

지오코딩
- 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스
- 1600 Amphitheatre Parkway CA -> 위도 37.401, 경도 -122.083 이다.
- 이 반대는 역 지오코딩(reverse geocoding) 이다

경로 안내 알고리즘을 위한 도로데이터 처리
- 대부분의 경로 탐색 알고리즘은 다익스트라(Djikstra) 알고리즘이나 A* 경로 탐색 알고리즘의 변종임

### 개략적 규모 추정
- 설계 초점이 모바일 단말이므로, 데이터 사용량과 배터리 효율을 중요하게 따져봐야 한다
- 다음 세가지 종류의 데이터를 저장해야 한다
	- 세계 지도
	- 메타데이터
	- 도로 정보
- 지구를 타일로 나누어 계산해보면 전부 저장하는데는 440PB 정도 든다.
하지만 지구 표면 가운데 90% 는 인간이 살지 않는 자연 그대로이니, 이 이미지는 아주 높은 비율로
압축하면 되니 그만큼 용량을 절감할 수 있다

## 개략적 설계안 제시 및 동의 구하기

다음 기능을 제공
1. 위치 서비스
2. 경로 안내 서비스
3. 지도 표시

위치 서비스
- 클라이언트가 t 초 마다 자기 위치를 서버로 전송해야함
- 사용자 위치 이력을 클라이언트에 버퍼로 저장했다가 일괄 전송(batch)하면 전송 빈도를 줄일수 있다
- 이럼에도 많은 쓰기요청을 처리해야하므로, 높은 쓰기요청빈도에 최적화되있고 규모확장이 용이한 카산드라같은 디비가 필요하다
- 통신 프로토콜로는 HTTP 를 keep-alive 옵션과 함께 사용하면 효율을 높일 수 있는 좋은 선택이다

경로 안내 서비스
API 이용??

지도 표시
- 클라이언트의 현재 위치 확대수준을 근거한 지도타일 집합을 결정해야함, 그리고 그 위치를 지오해시 URL 로 변환
- 해당 타일에 대한 정적 이미지를 CDN 을 통해 가져옴
- 사람들은 같은길을 일상적으로 이용하는 경향이 있어 클라이언트 캐시에 두면 데이터 사용량을 줄일수있음

<br />

# 분산 메시지 큐

메시지 큐의 장점
- 결합도 완화
- 규모 확장성 개선
- 가용성 개선
- 성능 개선

## 문제 이해 및 설계 범위 확정

Q. 메시지의 형태와 평균 크기는? 텍스트만 지원하면 되는지?
A. 텍스트만 지원하면 되고 크기는 KB 수준

Q. 반복적인 소비가 가능해야 하는지?
A. 여러 소기자가 수신하는것이 가능해야함

Q. 메시지는 큐에 전달된 순서대로 소비되어야 하는지?
A. 생산된 순서대로 소비되어야 함

Q. 데이터의 지속성이 보장되어야 하는지?
A. 2주 정도로 잡음

Q. 지원해야 하는 생성자 / 소비자 수는?
A. 많을수록 좋음

Q. 어떤 방식을 지원해야하는지, 예를들면 최대 한번, 최소 한번, 정확히 한번
A. 최소 한번을 지원

Q. 목표로 삼아야 할 대역폭과 단대단(end to end) 지연 시간은?
A. 높은 대역 낮은 대역 모두 지원해야함



상세 설계

### 토픽을 어디에 보관해야 좋을까?
- 쓰기 우선로그(Write-Ahead Log, WAL)
- WAL 은 새로운 항목이 추가되기만 하는 append only 파일이다.
WAL 은 많이 활용되는데 mysql 의 복구 로그, 그리고 아파치 주키퍼도 WAL 을 사용한다

WAL 에 대한 접근 패턴은 읽기/쓰기 모두 순차적이고, 접근 패턴도 순차적일때는 아주 좋은 성능을 보인다
+ 회전식 디스크 기반 저장장치는 큰 용량을 저렴하게 제공한다

### 컨슈머 리밸런싱
- 컨슈머가 어떤 파티션을 책임질지 다시 정하는 프로세스, 새로운 컨슈머가 합류하거나 기존 컨슈머가 그룹을 떠나거나 혹은 컨슈머에 장애가 발생하는 등의 상황에서 발생한다
이때 이를 조정해주는것이 coordinator

- coordinator 는 각 컨슈머로부터 heartbeat 메시지를 살피고 각 컨슈머의 파티션 내 오프셋 정보를 관리한다

### 상태 저장소(State Storage)
- 브로커의 상태저장소에는 다음과 같은 정보가 저장된다
	- 소비자에 대한 파티션의 배치 관계
	- 컨슈머 그룹이 각 파티션에서 마지막으로 가져간 메시지의 오프셋
- 해당 정보의 특징은 읽기/쓰기가 빈번하지만 양이 많지는 않음, 갱신이 빈번하지만 삭제되는일은 거의 없음
- 읽기/쓰기 연산은 무작위적 패턴을 보임
- 이런 요구사항을 고려했을땐 주키퍼의 키-값 저장소를 사용하는것이 바람직함

### 메타데이터 저장소
- 토픽 설정이나 속성 정보를 관리, 파티션 수, 메시지 보관기간, 사본 배치 정보 등이 해당함
- 메타데이터는 자주 변경되지 않으며 양도 적다, 하지만 높은 일관성을 요구한다
- 이런 데이터의 보관은 주키퍼가 적절함

### 주키퍼
- 주키퍼는 계층적 키-값 저장소 기능을 제공하는, 분산 시스템에 필수적인 서비스이다.
- 메타데이터와 상태 저장소는 주키퍼를 이용해 구현
- 브로커는 이제 메시지 데이터 저장소만 유지하면 됨
- 주키퍼가 브로커 클러스터의 리더 선출 과정을 돕는다

### 복제
- 분산 시스템에서 하드웨어 장애는 흔하므로 무시해선 안된다
- 디스크가 손상되면 데이터가 사라지기에 이런 문제를 해결하고 높은 가용성을 보장하기 위해서는
복제기능을 사용해야 한다.


### 사본 동기화
- 메시지는 여러 파티션에 두며, 각 파티션은 다시 여러 사본으로 복제된다
- 메시지는 리더에게만 보내고 다른 사본은 리더에게서 메시지를 가져와 동기화한다
- 그럼 어떻게 동기화를 하는걸까?

동기화된 사본(In-Sync Replicas, ISR)
- 즉, 리더 파티션과 팔로워 파티션이 모두 동기화되어있는 상태
- replica.lag.max.messages 의 값이 만약 4로 설정되있다고 가정하면,
만약 단순 사본에 보관된 메시지 개수와 리더 사이의 차이가 3이라면 해당 사본은 여전히 ISR 이다

#### ACK=all
- 프로듀서는 모든 ISR 이 메시지를 수신한 뒤에 ACK 응답을 받음
- 느린 ISR 응답을 기다려야 하므로 메시지를 보내기 위한 시간이 길어짐

#### ACK=1
- 프로듀서는 리더가 메시지를 저장하고 난 후 바로 ACK 응답을 받음
- 동기화될때까지 기다리지 않음

#### ACK=0
- 프로듀서는 보낸 메시지에 대한 수신 확인 메시지를 기다리지 않고 계속 메시지를 전송함
- UDP 와 비슷

#### 메시지 큐는 어떤 프로토콜을 쓸까?
- AMQP
	- Advanced Message Queue Protocol 의 약자로 메시지 지향 미들웨어(MOM)를 위한 개방형 표준 응용 계층 프로토콜
	- 메세지 큐 구조에 Exchange 라는 라우터 역할이 존재. 
	- Exchange는 Publisher에게 메시지를 수신 받으면 그것을 Queue에게 분배해주는 역할을 함
- Kafka Protocol
	- 카프카는 TCP 를 이용한 binary Protocol 을 사용
	- 브로커와는 커넥션을 유지하여 handshake 와 같은 과정을 생략해 효율적으로 통신함


# Chapter05. 지표 모니터링 및 경보시스템

Q. 시스템의 고객은 누구인가요? 대형 IT 업체인지, 아님 데이터독같은 SaaS 제품인지?
A. 회사 내부 시스템이다

Q. 어떤 지표를 수집할지?
A. 시스템 운영 지표를 수집, 이 지표에는 CPU 부하, 메모리 사용률, 디스크 사용량도 있고
RPS 나 웹서버 프로세스 개수도 포함

Q. 모니터링 할 인프라 규모는 어느정도인지?
A. DAU 는 1억이고, 1000개의 서버 풀이 있고 풀마다 100개의 하드웨어가 있음

Q. 데이터는 얼마나 유지되는지?
A. 1년동안 보관되어야 함

Q. 데이터를 장기 보관 저장소로 옮길때 해상도를 낮춰도 되는지?
A. 신규 데이터는 7일간 보관하고, 7일 뒤는 1분 단위로 만들어 30일간 보관, 그 뒤는 1시간 단위로 보관

Q. 경보 채널로는 어떤것들을 지원해야 할지?
A. 이메일, 전화, 웹훅(HTTP Protocol) 을 지원

Q. 에러로그나 액세스 로그에 대한 수집기능도 제공할지?
A. 괜찬

Q. 분산 시스템 추적 기능도 제공할지?
A. 괜찬

## 개략적 요구사항 및 가정
- 대규모 인프라를 모니터링 해야 함
	- DAU 1억
	- 서버 풀 1,000개 , 풀당 서버수 100개, 서버당 하드웨어 100개
	- 보관은 1년
	- 보관된 데이터는 시간이 지나면서 해상도를 낮춘다

- 모니터링 할 지표
	- CPU 사용률
	- 요청 수 (RPS)
	- 메모리 사용량
	- 메시지 큐 내의 메시지 수

비기능 요구사항
- 규모 확장성: 늘어나는 지표와 정보의 양에 맞게 확장되어야 함
- 질의에 대한 낮은 응답지연을 보장
- 안정성
- 유연성

기본 사항
- 데이터 수집: 여러 출처로부터 지표 데이터를 수집
- 데이터 전송: 지표 데이터를 지표 모니터링 시스템으로 전송
- 데이터 저장소: 전송되어 오는 데이터를 정리하고 저장
- 경보: 데이터를 분석하고 이상징후를 감지해 경보를 발생
- 시각화: 데이터를 차트나 그래프로 제공

지표시스템은 일반적으로 쓰기에 대한 부하가 막대하다.
읽기 부하는 일시적으로 치솟다가 사라지는(Spike) 편이다

지표를 저장하기 시장에서 가장 인기있는 시계열 데이터베이스는 InflixDB, 프로메테우스 이다