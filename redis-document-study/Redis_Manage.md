# Redis Manage

## Redis Sentinel 을 통한 고가용성

- 모니터링 : Sentinel은 마스터 및 복제본 인스턴스가 예상대로 작동하는지 지속적으로 확인합니다.
- 알림 : Sentinel은 모니터링되는 Redis 인스턴스 중 하나에 문제가 있음을 API를 통해 시스템 관리자나 다른 컴퓨터 프로그램에 알릴 수 있습니다.
- 자동 장애 조치 : 마스터가 예상대로 작동하지 않는 경우 Sentinel은 복제본이 마스터로 승격됩니다.
- 구성 공급자 : Sentinel은 클라이언트 서비스 검색을 위한  소스 역할을 합니다.  
클라이언트는 Redis 마스터의 주소를 요청하기 위해 Sentinel에 연결합니다. 장애 조치가 발생하면 Sentinels는 새 주소를 보고합니다.



## Redis Replication
- 레디스는 비동기(asynchronous) 복제를 합니다.
- 마스터는 Replica Server 를 여러 개 둘 수 있습니다.
- Replica Server 는 또 다른 Replica Server 를 둘 수 있습니다.
- Master -> Replica1 -> Replica2 이런 구성이 됩니다.
- 마스터에 많은 데이터가 있는 상태에서 Replica Server 를 구성하면, 대량의 데이터가 Replica Server 로 보내질것입니다.  
이 때에도 마스터는 멈추지 않고 정상적으로 요청을 처리합니다. 왜냐하면 데이터를 Replica Server 로 보내는(RDB 파일을 생성하는) 작업은 자식 프로세스가 처리하기 때문입니다.
- Replica Server 에서 조회 요청을 처리하도록 하는 것도 부하분산을 위한 좋은 방법입니다.  
특히 SORT 명령같은 것들은 복제서버에서 수행하는 것이 좋습니다.
- 마스터의 부하를 줄이기 위해서, AOF 쓰기나 RDB 파일 생성을 Replica Server 에서 수행하는 것도 좋은 방법입니다.  
하지만 이런 설정을 했을 경우에는 마스터 자동 시작 하도록 하면 데이터가 유실 될 수 있습니다.

### 전체 동기화 (Full Synchronization)

- 복제 순서
    1. 마스터는 자식 프로세스를 시작해 백그라운드로 RDB파일에 데이터를 저장합니다.
    2. 데이터를 저장하는 동안 마스터에 새로 들어온 명령들은 처리 후 복제 버퍼에 저장됩니다.
    3. RDB 파일 저장이 완료되면, 마스터는 파일을 복제 서버에게 전송합니다.
    4. 복제서버는 파일을 받아 디스크에 저장하고, 메모리로 로드합니다.
    5. 마스터는 복제 버퍼에 저장된 명령을 복제서버에게 전송합니다.

- 레디스 2.8.18 부터는 RDB 파일을 디스크에 만들지 않고 복제하는 기능을 제공합니다. (디스크 대신 소켓을 이용함)
- 마스터가 살아나면 복제서버에 복제 순서에 따라 Sync를 합니다. 복제서버가 여러 개 일때도 RDB 파일은 하나만 생성합니다.


### 부분 동기화 (Partial reSynchronization)

- 마스터와 복제서버는 각 서버의 run id 와 replication offset을 가지고 있습니다.  
마스터와 복제서버간 네트워크가 끊어지면 마스터는 복제서버에 전달할 데이터를 `backlog-buffer` 에 저장합니다. 
- 다시 연결되었을 때 `backlog-buffer` 가 넘치지 않았으면 run id와 offset을 비교해서 그 이후 부터 동기화를 합니다. 이것을 부분 동기화라고 합니다.  
`Backlog-buffer` 크기는 `repl-backlog-size` 파라미터로 설정합니다.  
부분 동기화 기능은 레디스 버전 2.8 부터 제공됩니다.

- 네크워트 단절 시간이 길어져 마스터의 `backlog-buffer` 가 넘치면 다시 연결되었을 때 __전체 동기화(full synchronization)__ 를 합니다.  
마스터나 복제서버 중 한쪽이 재시작했을 경우에도 전체 동기화를 합니다.

